include:
  - component: gitlab.library.upenn.edu/devops/gitlab/components/general/vault_jwt_auth@~latest
    inputs:
        vault_addr: ${VAULT_ADDR}
        vault_auth_path: ${VAULT_AUTH_PATH}
        vault_auth_role: ${VAULT_AUTH_ROLE}

  - project: "devops/gitlab/ci-templates/ruby"
    ref: "sans-dind"
    file:
      - ".rspec.yml"
      - ".rubocop.yml"

stages:
  - test
  - deploy

rspec_app_test:
  stage: test
  image: ruby:3.2.2
  before_script:
    - bundle install -j $(nproc)
  extends:
    - .rspec
  tags:
    - build

rubocop_app_test:
  stage: test
  image: ruby:3.2.2
  before_script:
    - bundle install -j $(nproc)
  extends:
    - .rubocop
  tags:
    - build

# This step was inspired from Gitlab's example of gem publication:
# https://gitlab.com/gitlab-org/quality/pipeline-common/-/blob/master/ci/gem-release.yml
gem_publication:
  stage: deploy
  image: ruby:3.2.2
  variables:
    GEMSPEC_FILE: "${CI_PROJECT_NAME}.gemspec"
  before_script:
     - >
      if [ -x "$(command -v apk)" ]; then
        apk add --no-cache $[[ inputs.deps ]]
      elif [ -x "$(command -v apt-get)" ]; then
        apt-get update && apt-get -y install $[[ inputs.deps ]]
      elif [ -x "$(command -v yum)" ]; then
        yum install -y $[[ inputs.deps ]]
      fi

  script:
    - GEM_FILE=$(echo "${CI_PROJECT_NAME}-${CI_COMMIT_TAG:1}.gem")
    - |
      gem build "${GEMSPEC_FILE}"
      [ -f "${GEM_FILE}" ] || (echo "No ${GEM_FILE} file found!" && exit 1)
    - '[ "${DISABLE_GEM_PUSH}" == "true" ] || gem push "${GEM_FILE}"'
  rules:
     - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+(\.[a-zA-Z0-9]+)?$/
  artifacts:
    paths:
      - "*.gem"
  tags:
    - deploy
